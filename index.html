<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="generator" content="pandoc" />
        <meta http-equiv="X-UA-Compatible" content="IE=EDGE" />
        <title> scEpigenomics: CAR-T</title>
        <script src="scriptformat1.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link href="linkformat1.css"rel="stylesheet" />
        <style>h1 {font-size: 34px;}
            h1.title {font-size: 38px;}
            h2 {font-size: 30px;}
            h3 {font-size: 24px;}
            h4 {font-size: 18px;}
            h5 {font-size: 16px;}
            h6 {font-size: 12px;}
            code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
            pre:not([class]) { background-color: white }</style>
        
        
        <style type="text/css">
            code{white-space: pre-wrap;}
            span.smallcaps{font-variant: small-caps;}
            span.underline{text-decoration: underline;}
            div.column{display: inline-block; vertical-align: top; width: 50%;}
            div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
            ul.task-list{list-style: none;}
        </style>

        <style type="text/css">code{white-space: pre;}</style>
        <script type="text/javascript">
            if (window.hljs) {
                hljs.configure({languages: []});
                hljs.initHighlightingOnLoad();
                if (document.readyState && document.readyState === "complete") {
                    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
                }
            }
        </script>


        <style type="text/css">
            .main-container {
            max-width: 940px;
            margin-left: auto;
            margin-right: auto;
            }
            img {
            max-width:100%;
            }
            .tabbed-pane {
            padding-top: 12px;
            }
            .html-widget {
            margin-bottom: 20px;
            }
            button.code-folding-btn:focus {
            outline: none;
            }
            summary {
            display: list-item;
            }
            details > summary > p:only-child {
            display: inline;
            }
            pre code {
            padding: 0;
            }
        </style>

        <!-- tabsets -->

        <style type="text/css">
        .tabset-dropdown > .nav-tabs {
        display: inline-table;
        max-height: 500px;
        min-height: 44px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        }

        .tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
        content: "\e259";
        font-family: 'Glyphicons Halflings';
        display: inline-block;
        padding: 10px;
        border-right: 1px solid #ddd;
        }

        .tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
        content: "\e258";
        font-family: 'Glyphicons Halflings';
        border: none;
        }

        .tabset-dropdown > .nav-tabs > li.active {
        display: block;
        }

        .tabset-dropdown > .nav-tabs > li > a,
        .tabset-dropdown > .nav-tabs > li > a:focus,
        .tabset-dropdown > .nav-tabs > li > a:hover {
        border: none;
        display: inline-block;
        border-radius: 4px;
        background-color: transparent;
        }

        .tabset-dropdown > .nav-tabs.nav-tabs-open > li {
        display: block;
        float: none;
        }

        .tabset-dropdown > .nav-tabs > li {
        display: none;
        }
        </style>

        <!-- code folding -->
        <style type="text/css">
        .code-folding-btn { margin-bottom: 4px; }
        </style>

        <style type="text/css">

        #TOC {
        margin: 25px 0px 20px 0px;
        }
        @media (max-width: 768px) {
        #TOC {
        position: relative;
        width: 100%;
        }
        }

        @media print {
        .toc-content {
        /* see https://github.com/w3c/csswg-drafts/issues/4434 */
        float: right;
        }
        }

        .toc-content {
        padding-left: 30px;
        padding-right: 40px;
        }

        div.main-container {
        max-width: 1200px;
        }

        div.tocify {
        width: 20%;
        max-width: 260px;
        max-height: 85%;
        }

        @media (min-width: 768px) and (max-width: 991px) {
        div.tocify {
            width: 25%;
        }
        }

        @media (max-width: 767px) {
        div.tocify {
            width: 100%;
            max-width: none;
        }
        }

        .tocify ul, .tocify li {
        line-height: 20px;
        }

        .tocify-subheader .tocify-item {
        font-size: 0.90em;
        }

        .tocify .list-group-item {
        border-radius: 0px;
        }


        </style>
    </head>
    <body>
        <div class="container-fluid main-container">
        <!-- setup 3col/9col grid for toc_float and main content -->
        <div class="row">
            <div class="col-xs-12 col-sm-4 col-md-3">
            <div id="TOC" class="tocify"></div>
            </div>

            <div class="toc-content col-xs-12 col-sm-8 col-md-9">
            <h1>Welcome to CompBioWizard/scEpigenimics project</h1>

            <div id="header">
                <div class="btn-group pull-right float-right">
                <button
                    type="button"
                    class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle"
                    data-toggle="dropdown"
                    data-bs-toggle="dropdown"
                    aria-haspopup="true"
                    aria-expanded="false"
                >
                    <span>Code</span>
                    <span class="caret"></span>
                </button>

                <ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
                    <li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
                    <li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
                </ul>
                </div>

                <h1 class="title toc-ignore">CAR-T Analaysis</h1>
            </div>

            <p><em>File Update: June 3, 2025</em></p>
            <p>
                Xusheng Ai
                (<a href="mailto:xai@mdanderson.org" class="email">xai@mdanderson.org</a>)
            </p>

            <div id="SET UP" class="section level1">
                <h2>0. Configure the Python environment</h2>
                <p>
                Go to the
                <a
                    href="https://github.com/CompBioWizard/scEpigenomics.git"
                    target="_blank"
                    rel="noopener noreferrer"
                    >Github repo</a
                >
                and follow the Installation.
                </p>
            </div>

            <div id="sample-k4me3-cell-x-50kb-bin" class="section level2">
                <h2>1. Samples K4me3: 50kb bin × cell</h2>
                <p>First read the BED file and create the tile matrix:</p>
                <pre class="r"><code># Using Python 3
# If the tile‑matrix file is provided
python -m bin.genomicspipeline --config <config file path> --matrix_file <matrix file path>
# Else create the tile matrix from the BED file
python -m bin.genomicspipeline --config <config file path>
# The tile‑matrix file will be stored under the results folder        
    </code></pre>
            </div>

            <div id="normalization-iterativelsi" class="section level3">
                <h2>2. Normalization: IterativeLSI</h2>
                <p>
                    Tuning parameters: <code>n_components</code> = 50, 100, or 150;&nbsp;
                    dropout ratios for low-enriched tiles: 90 %, 95 %, and 99 %.
                </p>
            </div>

            <h2>3. UMAP Plots</h2>
            <p>
                Initial experiment: retain all tile features and normalize the matrix with
                <code>n_components</code> set to 50, 100, and 150.
            </p>
            <img src="results/alltile_vary_ncomp.png" width="672" alt="UMAP varying n_components">

            <p>
                Next, we set the minimum reads per tile to 10 (biological drop #1).  
                Based on the dropout rate and <code>var_features</code>, we tested several
                parameter combinations.
            </p>
            <img src="results/droptile_vary_ncomp.png" width="672" alt="drop‑tile parameter sweep">

            <p>
                Effect of varying dropout rate with <code>n_components = 50</code>:
            </p>
            <img src="results/droptile1_50ncomp.png" width="672" alt="run 1">
            <img src="results/droptile2_50ncomp.png" width="672" alt="run 2">
            <img src="results/droptile3_50ncomp.png" width="672" alt="run 3">
            <img src="results/droptile4_50ncomp.png" width="672" alt="run 4">
            <img src="results/droptile5_50ncomp.png" width="672" alt="run 5">
            <img src="results/droptile6_50ncomp.png" width="672" alt="run 6">
            <img src="results/droptile7_50ncomp.png" width="672" alt="run 7">

            <h3>3.1. Cell‑density plot &amp; filter</h3>
            <p>
                After selecting tile features, we filtered out cells with low read counts.
                The figure below shows the density plot of the cell × tile matrix
                (<code>var_features</code> → 206 at a dropout ratio of 0.99).
            </p>
            <p>
                The resulting tile matrix has dimensions 23 336 × 20 646 after removing tiles
                with fewer than 10 reads. With a per-cell read threshold of 500, 272 cells
                remain; the most abundant contains 12 686 reads.
            </p>
            <img src="results/celldensity.png" width="672" alt="cell density">
            <p>
                The following UMAP plot colors cells by their read counts.
            </p>
            <img src="results/dropcell_tile.png" width="672" alt="plot">
            <p>
                For comparison, we retained all cells but set <code>n_neighbors = 50</code>
                and <code>min_dist = 0.2</code> in UMAP, producing a layout distinct from the
                plots above. The left UMAP plot is produced without dropping tile features (&lt; 10).
                The right UMAP plot is produced without dropping the tile features and cells.
            </p>
            <img src="results/allcell_droptile.png" width="336" alt="droptileplot">
            <img src="results/allcell_mostoftile.png" width="336" alt="droptileplot">
            <h3>3.2. imputation plot &amp; filter</h3>
            <p>
                The left panel applies KNN smoothing to the tile matrix; the right panel
                shows the original pipeline without smoothing. 
            </p>
            <img src="results/knn_dropcell_droptile_lsi.png" width="336" alt="knn">
            <img src="results/dropcell_tile.png" width="336" alt="origin">
            
            
            <h2>4. Filter &amp; Density plots comparsion  </h2>
            <p>
                For this experiment, we compare density plots from different 
                bed files and different scripts. The following is the comparsion
                for the function file.
                One approach extracts information directly from the bed file using a bash script.
                The other involves using Python to read the bed file and generate a cell-by-tile matrix.
            </p>
            <p>
                The left figure is a density plot generated by a Bash script that 
                extracts unique cells from a bed file. The right figure is a density
                plot generated by a Python script.
                
            </p>
            <img src="results/verify/bash_Density_plot_pool1_DJ_Hs_CM_0_K4me123_070122.png" width="336" alt="origin">
            <img src="results/verify/python_Density_plot_pool1_DJ_Hs_CM_0_K4me123_070122.png" width="336" alt="origin">
            
            <img src="results/verify/ggplot_python_pool1_DJ_Hs_CM_0_K4me123_070122.png" width="336" alt="origin">
            <img src="results/verify/ggplot_R_pool1_DJ_Hs_CM_0_K4me123_070122.png" width="336" alt="origin">
            <p>
                The difference in density plots between R and Python is due to the
                chosen bandwidth for calculating the density. Python functions tend
                to use a larger bandwidth, making the curve smoother and obscuring
                local structure, while R’s ggplot2 produces a curve that retains more detail.
            </p>

            <h3>4.1 The number of cell kept</h3>
            <p>
                To track the number of cells kept after filtering for cells with 
                at least 300 unique fragments (K4), the count in the provided example
                is 389 (pool1), while the count from the Python script is 345 (pool1).
            </p>
            <p>
                This differnce is because of in the python script, it does not count 
                sub chrom informaiton like chromosome x and y
            </p>
            <p>
                set the <code>threshold</code> to be <b>100</b>:
                The file information:results/tile_matrix_DJ_Hs_CM_0_K4me123_070122.npz
                [filter] Kept 20646 / 57509 tiles (≥10 reads)
                The information of the tile matrix :(23336, 20646)
                The length of the totla reads:22053
                The max of the reads:12686
                [cell filter] keeping 575 / 22053 cells (reads ≥ 100)
                [drop=0.90] kept 20646/20646 tiles; var_features→2064
                [smooth] building KNN graph (k=15) …
                [smooth] aggregating values …
                [drop=0.90] kept 20646/20646 tiles; var_features→2064
            </p>
            <img src="results/miniread10_thresdhold100_drop0.9_smooth.png" width="672" alt="origin">
            
            <p>
                set the <code>threshold</code> to be <b>300</b>:
                The file information:results/tile_matrix_DJ_Hs_CM_0_K4me123_070122.npz
                [filter] Kept 20646 / 57509 tiles (≥10 reads)
                The information of the tile matrix :(23336, 20646)
                The length of the totla reads:22053
                The max of the reads:12686
                [cell filter] keeping 345 / 22053 cells (reads ≥ 300)
                [drop=0.90] kept 20646/20646 tiles; var_features→2064
                [smooth] building KNN graph (k=15) …
                [smooth] aggregating values …
                [drop=0.90] kept 20646/20646 tiles; var_features→2064
            </p>
            <img src="results/miniread10_thresdhold300_drop0.9_smooth.png" width="672" alt="origin">
            
            <p>
                Set the <code>threshold</code> to be <b>500</b>:
                The file information:results/tile_matrix_DJ_Hs_CM_0_K4me123_070122.npz
                [filter] Kept 20646 / 57509 tiles (≥10 reads)
                The information of the tile matrix :(23336, 20646)
                The length of the totla reads:22053
                The max of the reads:12686
                [cell filter] keeping 272 / 22053 cells (reads ≥ 500)
                [drop=0.90] kept 20646/20646 tiles; var_features→2064
                [smooth] building KNN graph (k=15) …
                [smooth] aggregating values …
                [drop=0.90] kept 20646/20646 tiles; var_features→2064
            </p>
            <img src="results/miniread10_thresdhold500_drop0.9_smooth.png" width="672" alt="origin">
            

            <h3>4.2 read another sample from pool2</h3>
            <p>
                We also ran the Python script with different bed files (pool1 and pool2).
                The following figure is the density plot from pool2 (K4).
            </p>
            <img src="results/verify/python_Density_plot_pool2_DJ_Hs_CM_0_K4me123_070122.png" width="336" alt="origin">
            <p>
                set the <code>threshold</code> to be <b>100</b>:
                The file information:results/tile_matrix_pool2_DJ_Hs_CM_0_K4me123_070122.bed.npz
                [filter] Kept 22780 / 57509 tiles (≥10 reads)
                The information of the tile matrix :(23894, 22780)
                The length of the totla reads:22987
                The max of the reads:25720
                [cell filter] keeping 534 / 22987 cells (reads ≥ 100)
                [drop=0.90] kept 20646/22780 tiles; var_features→2064
                [smooth] building KNN graph (k=15) …
                [smooth] aggregating values …
                [drop=0.90] kept 20646/22780 tiles; var_features→2064
            </p>
            <img src="results/miniread10_thresdhold100_drop0.9_smooth_pool2.png" width="672" alt="origin">
            
            
            
            <p>
                set the <code>threshold</code> to be <b>300</b>:
                The file information:results/tile_matrix_pool2_DJ_Hs_CM_0_K4me123_070122.bed.npz
                [filter] Kept 22780 / 57509 tiles (≥10 reads)
                The information of the tile matrix :(23894, 22780)
                The length of the totla reads:22987
                The max of the reads:25720
                [cell filter] keeping 305 / 22987 cells (reads ≥ 300)
                [drop=0.90] kept 20646/22780 tiles; var_features→2064
                [smooth] building KNN graph (k=15) …
                [smooth] aggregating values …
                [drop=0.90] kept 20646/22780 tiles; var_features→2064
            </p>
            <img src="results/miniread10_thresdhold300_drop0.9_smooth_pool2.png" width="672" alt="origin">
            
            <p>
                set the <code>threshold</code> to be <b>500</b>:
                The file information:results/tile_matrix_pool2_DJ_Hs_CM_0_K4me123_070122.bed.npz
                [filter] Kept 22780 / 57509 tiles (≥10 reads)
                The information of the tile matrix :(23894, 22780)
                The length of the totla reads:22987
                The max of the reads:25720
                [cell filter] keeping 252 / 22987 cells (reads ≥ 500)
                [drop=0.90] kept 20646/22780 tiles; var_features→2064
                [smooth] building KNN graph (k=15) …
                [smooth] aggregating values …
                [drop=0.90] kept 20646/22780 tiles; var_features→2064
            </p>
            <img src="results/miniread10_thresdhold500_drop0.9_smooth_pool2.png" width="672" alt="origin">
            <h3>4.3 concatenate samples from pool1 and pool2</h3>
            <p>
                set the <code>threshold</code> to be <b>100</b>:
                The file information:['results/tile_matrix_pool2_DJ_Hs_CM_0_K4me123_070122.bed.npz', 'results/tile_matrix_DJ_Hs_CM_0_K4me123_070122.npz']
                [filter] Kept 34320 / 57509 tiles (≥10 reads)
                The information of the tile matrix :(47230, 34320)
                The length of the totla reads:46052
                The max of the reads:28983
                [cell filter] keeping 1205 / 46052 cells (reads ≥ 100)
                [drop=0.90] kept 20646/34320 tiles; var_features→2064
                [smooth] building KNN graph (k=15) …
                [smooth] aggregating values …
                [drop=0.90] kept 20646/34320 tiles; var_features→2064
            </p>
            <img src="results/miniread10_thresdhold100_drop0.9_smooth_pool1n2.png" width="672" alt="origin">
            
            <p>
                set the <code>threshold</code> to be <b>300</b>:
                The file information:['results/tile_matrix_pool2_DJ_Hs_CM_0_K4me123_070122.bed.npz', 'results/tile_matrix_DJ_Hs_CM_0_K4me123_070122.npz']
                [filter] Kept 34320 / 57509 tiles (≥10 reads)
                The information of the tile matrix :(47230, 34320)
                The length of the totla reads:46052
                The max of the reads:28983
                [cell filter]  keeping 685 / 46052 cells (reads ≥ 300)
                [drop=0.90] kept 20646/34320 tiles; var_features→2064
                [smooth] building KNN graph (k=15) …
                [smooth] aggregating values …
                [drop=0.90] kept 20646/34320 tiles; var_features→2064
            </p>
            <img src="results/miniread10_thresdhold300_drop0.9_smooth_pool1n2.png" width="672" alt="origin">
            <p>
                set the <code>threshold</code> to be <b>500</b>:<br>
                The file information: ['results/tile_matrix_pool2_DJ_Hs_CM_0_K4me123_070122.bed.npz',
                'results/tile_matrix_DJ_Hs_CM_0_K4me123_070122.npz']<br>
                [filter] Kept 34320 / 57509 tiles (≥10 reads)<br>
                The information of the tile matrix : (47230, 34320)<br>
                The length of the total reads : 46052<br>
                The max of the reads : 28983<br>
                [cell filter] keeping 546 / 46052 cells (reads ≥ 500)<br>
                [drop = 0.90] kept 20646 / 34320 tiles; var_features → 2064<br>
                [smooth] building KNN graph (k = 15)…<br>
                [smooth] aggregating values …<br>
                [drop = 0.90] kept 20646 / 34320 tiles; var_features → 2064
            </p>
            <img src="results/miniread10_thresdhold500_drop0.9_smooth_pool1n2.png" width="672" alt="origin">
            
            </div>
        </div>
        </div>

        <!-- Scripts ---------------------------------------------------------->

        <script>
        // Add Bootstrap table styles to pandoc tables
        function bootstrapStylePandocTables() {
            $("tr.odd").parent("tbody").parent("table").addClass("table table-condensed");
        }
        $(document).ready(function () {
            bootstrapStylePandocTables();
        });
        </script>

        <!-- Tabsets -->
        <script>
        $(document).ready(function () {
            window.buildTabsets("TOC");

            $(".tabset-dropdown > .nav-tabs > li").click(function () {
            $(this).parent().toggleClass("nav-tabs-open");
            });
        });
        </script>

        <!-- Code folding -->
        <script>
        $(document).ready(function () {
            window.initializeCodeFolding("show" === "show");
        });
        </script>

        <script>
        $(document).ready(function () {
            // Temporarily add toc-ignore selector to headers for consistency with Pandoc
            $(".unlisted.unnumbered").addClass("toc-ignore");

            // Move toc-ignore selectors from section div to header
            $("div.section.toc-ignore")
            .removeClass("toc-ignore")
            .children("h1,h2,h3,h4,h5")
            .addClass("toc-ignore");

            // TOC options
            var options = {
            selectors: "h1,h2,h3",
            theme: "bootstrap3",
            context: ".toc-content",
            hashGenerator: function (text) {
                return text.replace(/[.\\/?&!#<>]/g, "").replace(/\s/g, "_");
            },
            ignoreSelector: ".toc-ignore",
            scrollTo: 0,
            showAndHide: true,
            smoothScroll: true,
            };

            // Initialise tocify
            $("#TOC").tocify(options).data("toc-tocify");
        });
        </script>

        <!-- Dynamically load MathJax for self‑contained compatibility -->
        <script>
        (function () {
            var script = document.createElement("script");
            script.type = "text/javascript";
            script.src =
            "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
            document.getElementsByTagName("head")[0].appendChild(script);
        })();
        </script>
    </body>
</html>
<h2>11.&nbsp;Week&nbsp;of&nbsp;16&nbsp;July</h2>

<h3>11.1&nbsp;Overview of weekly tasks</h3>
<ul>
  <li>Integrate RNAPII (CM_0) across modalities
    <ul>
      <li>For each cell type / time-point, collect the three K4 files (CUTAC, split1, split2) and the three K27 files.</li>
      <li>Sum their tile matrices to produce one RNAPII matrix per modality.</li>
    </ul>
  </li>
  <li>Run SEACells
    <ul>
      <li>Apply SEACells to each integrated RNAPII dataset (by cell type / time-point) to generate metacells.</li>
    </ul>
  </li>
  <li>Assemble multi-modal metacells
    <ul>
      <li>For each RNAPII barcode, extract the corresponding K4 and K27 single-cell data.</li>
    </ul>
  </li>
  <li>Repeat for all cell types & time-points.</li>
  <li>UMAP visualisation & separability checks
    <ul>
      <li>RNAPII only: Are cell types / time-points separable?</li>
      <li>K4 only: Assess clustering.</li>
      <li>K27 only: Assess clustering.</li>
      <li>K4&nbsp;+&nbsp;K27: Integrate by concatenating region matrices or via Seurat WNN; evaluate separability.</li>
    </ul>
  </li>
</ul>

<h3>11.2&nbsp;Integration of RNAPII modalities</h3>
<p>Tile size was set to 50 K, yielding a tile matrix of <strong>39 057 cells × 60 630 vars</strong>.</p>
<p><em>After outlier removal:</em></p>
<img src="results/section11/multitag_RNAPII_Noaggregation_umap_normalize_total_ntop20000nneighbor30_mindist0.1.png"
     width="500"
     alt="RNAPII UMAP without aggregation">

<p><em>After SEACells aggregation (metacell ratio = 10):</em></p>
<p>Dimensionality reduced to <strong>3 947 cells × 60 630 vars</strong>.</p>
<img src="results/section11/multitag_RNAPII_Aggregation_umap_normalize_total_ntop20000nneighbor30_mindist0.1.png"
     width="500"
     alt="RNAPII UMAP after aggregation">

<h3>11.3&nbsp;Filtering with high-quality RNAPII cells and K4/K27 mapping</h3>
<p><strong>Independent preprocessing (per sample)</strong></p>
<ol>
  <li>Create Arrow files.</li>
  <li>Filter cells (minFrags ≥ 300), remove doublets (<code>filterDoublets</code>), and drop outliers (DBSCAN).</li>
</ol>

<p><strong>Two-step cross-referencing</strong></p>
<ol>
  <li><em>Mask&nbsp;1 (iCell8 well matching):</em> match the first two barcode parts to identify cells from the same well.</li>
  <li><em>Mask&nbsp;2 (detailed barcode mapping):</em> use an 8-column mapping table (per cell type) to align the 3rd/4th barcode parts from RNAPII runs (CUTAC, split1, split2) to the K4/K27 references (last two columns).</li>
</ol>

<p>Example (CM_0) mapping table:</p>
<pre>
CUTbarcode3,CUTbarcode4,Split1barcode3,Split1barcode4,Split2barcode3,Split2barcode4,K4nK27barcode3,K4nK27barcode4
GAGATTCC,TATAGCCT,GAGATTCC,AATAACGT,AAGGAATC,TATAGCCT,AAGGAATC,AATAACGT
GAGATTCC,ATAGAGGC,GAGATTCC,CCATTGTG,AAGGAATC,ATAGAGGC,AAGGAATC,CCATTGTG
GAGATTCC,CCTATCCT,GAGATTCC,TTACGCCG,AAGGAATC,CCTATCCT,AAGGAATC,TTACGCCG
GAGATTCC,TTCTCGTA,GAGATTCC,AATTCTAA,AAGGAATC,TTCTCGTA,AAGGAATC,AATTCTAA
GAGATTCC,AGGCGAAG,GAGATTCC,GCGGTTAA,AAGGAATC,AGGCGAAG,AAGGAATC,GCGGTTAA
GAGATTCC,TAATCTTA,GAGATTCC,TGCGAAGT,AAGGAATC,TAATCTTA,AAGGAATC,TGCGAAGT
TCCGCGAA,TATAGCCT,TCCGCGAA,AATAACGT,TCTGGTTA,TATAGCCT,TCTGGTTA,AATAACGT
TCCGCGAA,ATAGAGGC,TCCGCGAA,CCATTGTG,TCTGGTTA,ATAGAGGC,TCTGGTTA,CCATTGTG
TCCGCGAA,CCTATCCT,TCCGCGAA,TTACGCCG,TCTGGTTA,CCTATCCT,TCTGGTTA,TTACGCCG
TCCGCGAA,TTCTCGTA,TCCGCGAA,AATTCTAA,TCTGGTTA,TTCTCGTA,TCTGGTTA,AATTCTAA
TCCGCGAA,AGGCGAAG,TCCGCGAA,GCGGTTAA,TCTGGTTA,AGGCGAAG,TCTGGTTA,GCGGTTAA
TCCGCGAA,TAATCTTA,TCCGCGAA,TGCGAAGT,TCTGGTTA,TAATCTTA,TCTGGTTA,TGCGAAGT
</pre>

<p>
  With metacell ratio = 10, applying both masks reduced the RNAPII metacells from <strong>3 947 to 1 574 cells</strong>.
</p>

<img src="results/section11/doublemask_multitag_RNAPII_Aggregation_umap_normalize_total_ntop20000nneighbor30_mindist0.1.png"
     width="500"
     alt="RNAPII metacells after double masking">

<p><strong>Metacell AnnData:</strong> 1 574 cells × 60 630 vars</p>
<img src="results/section11/doublemask_multitag_RNAPII_Noaggregation_umap_normalize_total_ntop20000nneighbor30_mindist0.1.png"
     width="500"
     alt="RNAPII raw cells after double masking">

<p><strong>Raw AnnData:</strong> 15 766 cells × 60 630 vars</p>

<h3>11.4&nbsp;Integrate K4 and K27 cells</h3>
<ol>
  <li>Identify cells via RNAPII barcodes and extract the corresponding K4/K27 single-cell profiles.</li>
  <li>Assign RNAPII metacell labels to K4/K27 cells.</li>
</ol>

<p>
  Using the RNAPII weight matrix, filter contributions from K4 and K27 separately via the mapping table, then compute metacells.
</p>

<p><strong>K4 metacells:</strong> 1 574 cells × 60 630 vars</p>
<img src="results/section11/doublemask_multitag_K4_Aggregation_umap_normalize_total_ntop20000nneighbor30_mindist0.1.png"
     width="500"
     alt="K4 metacells UMAP">

<p><strong>K4 raw cells:</strong> 9 927 × 60 630</p>
<img src="results/section11/doublemask_multitag_K4_Noaggregation_umap_normalize_total_ntop20000nneighbor30_mindist0.1.png"
     width="500"
     alt="K4 raw UMAP">

<p><strong>K27 metacells:</strong> 1 574 cells × 60 630 vars</p>
<img src="results/section11/doublemask_multitag_K27_Aggregation_umap_normalize_total_ntop20000nneighbor30_mindist0.1.png"
     width="500"
     alt="K27 metacells UMAP">

<p><strong>K27 raw cells:</strong> 5 839 × 60 630</p>
<img src="results/section11/doublemask_multitag_K27_Noaggregation_umap_normalize_total_ntop20000nneighbor30_mindist0.1.png"
     width="500"
     alt="K27 raw UMAP">

<h3>11.5&nbsp;Concatenating K4, K27, and RNAPII</h3>
<p><strong>Pipeline</strong></p>
<ol>
  <li><em>Initial loading & normalisation:</em> read each modality (H3K4me3, H3K27me3, RNAPII); apply <code>log1p</code> on total-normalised counts.</li>
  <li><em>Matrix concatenation:</em> horizontally concatenate normalised matrices.
    <ul>
      <li><strong>K4 + K27:</strong> 1 574 × 121 260</li>
      <li><strong>K4 + K27 + RNAPII:</strong> 1 574 × 181 890</li>
    </ul>
  </li>
  <li><em>Final processing:</em> re-normalise, then run PCA to obtain the latent space.</li>
</ol>

<img src="results/section11/K4K27_normalize_cancateaxis1_umap_normalize_total_ntop20000nneighbor30_mindist0.1.png"
     width="500"
     alt="K4+K27 concatenated UMAP">
<img src="results/section11/K4K27RNAPII_normalize_cancateaxis1_umap_normalize_total_ntop20000nneighbor30_mindist0.1.png"
     width="500"
     alt="K4+K27+RNAPII concatenated UMAP">

<h3>11.6&nbsp;Apply WNN to fuse the UMAP plot</h3>
<p><strong>Pipeline</strong></p>
<ol>
  <li>Normalise K4 and K27 separately with log-normalised counts.</li>
  <li>Compute PCA for each (<code>K4_pca</code>, <code>K27_pca</code>).</li>
  <li>Run WNN on the PCA embeddings to obtain a fused neighbour graph.</li>
</ol>

<p><strong>Python implementation of WNN:</strong></p>
<img src="results/section11/WNN_K4K27_umap_normalize_total_ntop20000nneighbor30_mindist0.1.png"
     width="500"
     alt="WNN fused UMAP (K4+K27)">

<h2>19. Week of September 10</h2>

<h3>19.1 Weekly Tasks</h3>
<p>This week's objectives included:</p>
<ul>
    <li>Reduce the number of cells for imputing the GeneScore (potentially impute at the metacell level)</li>
    <li>Cross-validate the Moran's I test and regression results</li>
    <li>Color-code the UMAP in a more interpretable way (set the maximum value of the heatmap range to the 3rd quartile of the maximum value)</li>
    <li>Develop a time-series machine learning model with attention mechanism for identifying marker genes</li>
</ul>

<h3>19.2 Reduced Imputation Cell Number for Single Cell GeneScore Matrix</h3>
<p>We investigated the impact of reducing the number of cells used for imputation. Even when reducing the cell number from 15 to 5, there was not much difference in the imputation results, suggesting that the method is robust to this parameter change.</p>

<div style="text-align: center; margin: 20px 0;">
    <img src="results/section19/imputedK3.png" style="width:600px;" alt="Imputation results with K=3 cells">
    <p><em>Imputation results using K=3 cells</em></p>
</div>

<div style="text-align: center; margin: 20px 0;">
    <img src="results/section19/imputedK15.png" style="width:600px;" alt="Imputation results with K=15 cells">
    <p><em>Imputation results using K=15 cells for comparison</em></p>
</div>

<p>We also implemented imputation at the metacell level to further optimize the process:</p>

<div style="text-align: center; margin: 20px 0;">
    <img src="results/section19/imputedK5_metacell.png" style="width:600px;" alt="Imputation at metacell level with K=5">
    <p><em>Imputation results at the metacell level using K=5</em></p>
</div>

<h3>19.3 Cross-Validation of Moran's I Test and Regression Results</h3>
<p>We performed comprehensive cross-validation analyses comparing Moran's I spatial autocorrelation tests with differential gene expression (DE) analysis at both single cell and metacell levels. This analysis helps validate the robustness of our findings across different statistical approaches and imputation strategies.</p>

<h4>Single Cell Level Analysis (K=15)</h4>

<h5>Overall Cross-Validation Statistics</h5>
<table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
    <tr style="background-color: #f2f2f2;">
        <th style="border: 1px solid #ddd; padding: 8px;">Metric</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Value</th>
    </tr>
    <tr>
        <td style="border: 1px solid #ddd; padding: 8px;">Total Moran's I significant genes</td>
        <td style="border: 1px solid #ddd; padding: 8px;">144,408</td>
    </tr>
    <tr>
        <td style="border: 1px solid #ddd; padding: 8px;">Total DE significant genes</td>
        <td style="border: 1px solid #ddd; padding: 8px;">115,079</td>
    </tr>
    <tr>
        <td style="border: 1px solid #ddd; padding: 8px;">Total overlapping genes</td>
        <td style="border: 1px solid #ddd; padding: 8px;">113,550</td>
    </tr>
    <tr>
        <td style="border: 1px solid #ddd; padding: 8px;">Overall Jaccard index</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.7780</td>
    </tr>
</table>

<h5>Modality-Specific Cross-Validation Results</h5>

<h6>H3K4me3 (K4) Modality</h6>
<table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
    <tr style="background-color: #f2f2f2;">
        <th style="border: 1px solid #ddd; padding: 8px;">Lineage</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Moran's I Genes</th>
        <th style="border: 1px solid #ddd; padding: 8px;">DE Genes</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Overlapping</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Jaccard Index</th>
        <th style="border: 1px solid #ddd; padding: 8px;">DE Precision</th>
    </tr>
    <tr>
        <td style="border: 1px solid #ddd; padding: 8px;">CM</td>
        <td style="border: 1px solid #ddd; padding: 8px;">23,028</td>
        <td style="border: 1px solid #ddd; padding: 8px;">18,568</td>
        <td style="border: 1px solid #ddd; padding: 8px;">17,987 (96.9%)</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.7618</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.9687</td>
    </tr>
    <tr>
        <td style="border: 1px solid #ddd; padding: 8px;">EM</td>
        <td style="border: 1px solid #ddd; padding: 8px;">23,445</td>
        <td style="border: 1px solid #ddd; padding: 8px;">19,773</td>
        <td style="border: 1px solid #ddd; padding: 8px;">19,240 (97.3%)</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.8024</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.9730</td>
    </tr>
</table>

<h6>H3K27me3 (K27) Modality</h6>
<table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
    <tr style="background-color: #f2f2f2;">
        <th style="border: 1px solid #ddd; padding: 8px;">Lineage</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Moran's I Genes</th>
        <th style="border: 1px solid #ddd; padding: 8px;">DE Genes</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Overlapping</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Jaccard Index</th>
        <th style="border: 1px solid #ddd; padding: 8px;">DE Precision</th>
    </tr>
    <tr>
        <td style="border: 1px solid #ddd; padding: 8px;">CM</td>
        <td style="border: 1px solid #ddd; padding: 8px;">24,768</td>
        <td style="border: 1px solid #ddd; padding: 8px;">18,384</td>
        <td style="border: 1px solid #ddd; padding: 8px;">18,384 (100%)</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.7422</td>
        <td style="border: 1px solid #ddd; padding: 8px;">1.0000</td>
    </tr>
    <tr>
        <td style="border: 1px solid #ddd; padding: 8px;">EM</td>
        <td style="border: 1px solid #ddd; padding: 8px;">24,630</td>
        <td style="border: 1px solid #ddd; padding: 8px;">20,147</td>
        <td style="border: 1px solid #ddd; padding: 8px;">20,083 (99.7%)</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.8132</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.9968</td>
    </tr>
</table>

<h6>RNAPII Modality</h6>
<table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
    <tr style="background-color: #f2f2f2;">
        <th style="border: 1px solid #ddd; padding: 8px;">Lineage</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Moran's I Genes</th>
        <th style="border: 1px solid #ddd; padding: 8px;">DE Genes</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Overlapping</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Jaccard Index</th>
        <th style="border: 1px solid #ddd; padding: 8px;">DE Precision</th>
    </tr>
    <tr>
        <td style="border: 1px solid #ddd; padding: 8px;">CM</td>
        <td style="border: 1px solid #ddd; padding: 8px;">24,460</td>
        <td style="border: 1px solid #ddd; padding: 8px;">18,877</td>
        <td style="border: 1px solid #ddd; padding: 8px;">18,816 (99.7%)</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.7673</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.9967</td>
    </tr>
    <tr>
        <td style="border: 1px solid #ddd; padding: 8px;">EM</td>
        <td style="border: 1px solid #ddd; padding: 8px;">24,077</td>
        <td style="border: 1px solid #ddd; padding: 8px;">19,330</td>
        <td style="border: 1px solid #ddd; padding: 8px;">19,040 (98.5%)</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.7813</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.9849</td>
    </tr>
</table>

<h4>Metacell Level Analysis (K=5)</h4>
<p>The metacell level analysis provides a different perspective on the cross-validation results, showing how the methods perform when applied to aggregated cell data rather than individual cells.</p>

<h5>H3K4me3 (K4) Modality - Metacell Level</h5>
<table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
    <tr style="background-color: #f2f2f2;">
        <th style="border: 1px solid #ddd; padding: 8px;">Lineage</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Moran's I Genes</th>
        <th style="border: 1px solid #ddd; padding: 8px;">DE Genes</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Overlap</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Jaccard Index</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Dice Coefficient</th>
        <th style="border: 1px solid #ddd; padding: 8px;">DE F1 Score</th>
    </tr>
    <tr>
        <td style="border: 1px solid #ddd; padding: 8px;">CM</td>
        <td style="border: 1px solid #ddd; padding: 8px;">15,911</td>
        <td style="border: 1px solid #ddd; padding: 8px;">14,939</td>
        <td style="border: 1px solid #ddd; padding: 8px;">12,017</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.6381</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.7791</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.7791</td>
    </tr>
    <tr>
        <td style="border: 1px solid #ddd; padding: 8px;">EM</td>
        <td style="border: 1px solid #ddd; padding: 8px;">15,821</td>
        <td style="border: 1px solid #ddd; padding: 8px;">16,404</td>
        <td style="border: 1px solid #ddd; padding: 8px;">12,450</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.6296</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.7727</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.7727</td>
    </tr>
</table>

<h5>H3K27me3 (K27) Modality - Metacell Level</h5>
<table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
    <tr style="background-color: #f2f2f2;">
        <th style="border: 1px solid #ddd; padding: 8px;">Lineage</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Moran's I Genes</th>
        <th style="border: 1px solid #ddd; padding: 8px;">DE Genes</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Overlap</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Jaccard Index</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Dice Coefficient</th>
        <th style="border: 1px solid #ddd; padding: 8px;">DE F1 Score</th>
    </tr>
    <tr>
        <td style="border: 1px solid #ddd; padding: 8px;">CM</td>
        <td style="border: 1px solid #ddd; padding: 8px;">20,812</td>
        <td style="border: 1px solid #ddd; padding: 8px;">12,004</td>
        <td style="border: 1px solid #ddd; padding: 8px;">11,233</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.5205</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.6846</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.6846</td>
    </tr>
    <tr>
        <td style="border: 1px solid #ddd; padding: 8px;">EM</td>
        <td style="border: 1px solid #ddd; padding: 8px;">18,006</td>
        <td style="border: 1px solid #ddd; padding: 8px;">16,260</td>
        <td style="border: 1px solid #ddd; padding: 8px;">13,125</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.6208</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.7661</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.7661</td>
    </tr>
</table>

<h5>RNAPII Modality - Metacell Level</h5>
<table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
    <tr style="background-color: #f2f2f2;">
        <th style="border: 1px solid #ddd; padding: 8px;">Lineage</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Moran's I Genes</th>
        <th style="border: 1px solid #ddd; padding: 8px;">DE Genes</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Overlap</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Jaccard Index</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Dice Coefficient</th>
        <th style="border: 1px solid #ddd; padding: 8px;">DE F1 Score</th>
    </tr>
    <tr>
        <td style="border: 1px solid #ddd; padding: 8px;">CM</td>
        <td style="border: 1px solid #ddd; padding: 8px;">20,464</td>
        <td style="border: 1px solid #ddd; padding: 8px;">15,268</td>
        <td style="border: 1px solid #ddd; padding: 8px;">13,842</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.6323</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.7748</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.7748</td>
    </tr>
    <tr>
        <td style="border: 1px solid #ddd; padding: 8px;">EM</td>
        <td style="border: 1px solid #ddd; padding: 8px;">20,633</td>
        <td style="border: 1px solid #ddd; padding: 8px;">16,740</td>
        <td style="border: 1px solid #ddd; padding: 8px;">15,060</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.6749</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.8059</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.8059</td>
    </tr>
</table>

<h4>Gene Consistency Analysis</h4>
<p>This analysis examines the consistency of gene identification across different lineages and methods, providing insights into the robustness of our findings.</p>

<table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
    <tr style="background-color: #f2f2f2;">
        <th style="border: 1px solid #ddd; padding: 8px;">Modality</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Genes in Both Lineages (Moran's)</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Genes in Both Lineages (DE)</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Genes in Both Methods and Lineages</th>
        <th style="border: 1px solid #ddd; padding: 8px;">Consistency Score</th>
    </tr>
    <tr>
        <td style="border: 1px solid #ddd; padding: 8px;">K4</td>
        <td style="border: 1px solid #ddd; padding: 8px;">10,507</td>
        <td style="border: 1px solid #ddd; padding: 8px;">9,964</td>
        <td style="border: 1px solid #ddd; padding: 8px;">6,403</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.2724</td>
    </tr>
    <tr>
        <td style="border: 1px solid #ddd; padding: 8px;">K27</td>
        <td style="border: 1px solid #ddd; padding: 8px;">15,393</td>
        <td style="border: 1px solid #ddd; padding: 8px;">8,205</td>
        <td style="border: 1px solid #ddd; padding: 8px;">6,357</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.2628</td>
    </tr>
    <tr>
        <td style="border: 1px solid #ddd; padding: 8px;">RNAPII</td>
        <td style="border: 1px solid #ddd; padding: 8px;">17,172</td>
        <td style="border: 1px solid #ddd; padding: 8px;">10,313</td>
        <td style="border: 1px solid #ddd; padding: 8px;">8,438</td>
        <td style="border: 1px solid #ddd; padding: 8px;">0.3450</td>
    </tr>
</table>

<h4>Comparative Analysis: Single Cell vs Metacell Level</h4>
<ul>
    <li><strong>Single Cell Level (K=15):</strong> Shows higher overall concordance with Jaccard indices ranging from 0.74-0.81 and DE precision of 96.9%-100%</li>
    <li><strong>Metacell Level (K=5):</strong> Shows more moderate concordance with Jaccard indices ranging from 0.52-0.67, indicating that aggregation affects method agreement</li>
    <li><strong>Method Robustness:</strong> Both approaches consistently identify significant genes, but single cell analysis provides higher precision in gene overlap detection</li>
    <li><strong>Computational Efficiency:</strong> Metacell level analysis offers computational advantages while maintaining reasonable concordance between methods</li>
    <li><strong>Gene Consistency:</strong> RNAPII shows the highest consistency score (0.3450) across methods and lineages, indicating robust gene identification</li>
</ul>

<h3>19.4 Enhanced UMAP Visualization with Robust Color Scaling</h3>
<p>To improve the interpretability of UMAP visualizations, we implemented robust color scaling by setting the heatmap range to 10-90% of the data range instead of using the full range. This approach reduces the impact of extreme outliers and provides better visual contrast for the majority of the data points.</p>

<h4>Robust Scaling Implementation</h4>
<p>We chose the 10-90% percentile range for the heatmap scaling to ensure that the color coding effectively represents the distribution of gene expression values while minimizing the influence of extreme outliers that could compress the color scale.</p>

<div style="text-align: center; margin: 20px 0;">
    <img src="results/section19/RNAPII_pseudotime_umap_robust_scaling.png" style="width:600px;" alt="UMAP with robust scaling applied to RNAPII pseudotime">
    <p><em>UMAP visualization with robust scaling (10-90% percentile range) applied to RNAPII pseudotime data</em></p>
</div>

<h4>Pseudotime and Gene Expression Overlay</h4>
<p>We developed an enhanced visualization approach that aligns pseudotime trajectories with high gene expression scores, providing a more intuitive representation of the temporal dynamics in the data.</p>

<div style="text-align: center; margin: 20px 0;">
    <img src="results/section19/RNAPII_pseudotime_expression_overlay.png" style="width:600px;" alt="UMAP with pseudotime and gene expression overlay">
    <p><em>UMAP visualization showing pseudotime trajectories overlaid with high gene expression scores for RNAPII</em></p>
</div>

<h4>Diagnostic Analysis of Top Genes</h4>
<p>To validate the robust scaling approach, we generated diagnostic histograms of the top genes to assess the distribution of expression values and confirm the effectiveness of the 10-90% percentile scaling.</p>

<div style="text-align: center; margin: 20px 0;">
    <img src="results/section19/RNAPII_robust_scaling_diagnostic.png" style="width:600px;" alt="Diagnostic histogram of top genes with robust scaling">
    <p><em>Diagnostic histogram showing the distribution of top gene expression values with robust scaling applied</em></p>
</div>

<h4>Visualization Improvements Summary</h4>
<ul>
    <li><strong>Robust Color Scaling:</strong> 10-90% percentile range reduces outlier impact and improves visual contrast</li>
    <li><strong>Enhanced Pseudotime Visualization:</strong> Clear alignment of temporal trajectories with gene expression patterns</li>
    <li><strong>Diagnostic Validation:</strong> Histogram analysis confirms effective scaling and data distribution representation</li>
    <li><strong>Improved Interpretability:</strong> Better visual distinction between different expression levels and temporal patterns</li>
</ul>